FROM nvcr.io/nvidia/pytorch:22.12-py3

# RUN pip install torch==1.6.0+cu101 torchvision==0.7.0+cu101 -f https://download.pytorch.org/whl/torch_stable.html

COPY requirements.txt ./
RUN pip install -r requirements.txt --ignore-installed PyYAML && rm ./requirements.txt
RUN pip install --upgrade protobuf

RUN pip install torch==1.5.1+cu101 torchvision==0.6.1+cu101 -f https://download.pytorch.org/whl/torch_stable.html
RUN git clone https://github.com/NVIDIA/apex.git &&\
    cd apex &&\
    pip install -v --no-cache-dir --global-option="--cpp_ext" --global-option="--cuda_ext" . &&\
    rm -rf ../apex

RUN pip install 'git+https://github.com/facebookresearch/fvcore'
RUN python -m pip install 'git+https://github.com/facebookresearch/detectron2.git@ffff8ac'

RUN HOROVOD_GPU_ALLREDUCE=NCCL HOROVOD_NCCL_LINK=SHARED HOROVOD_WITH_PYTORCH=1 \
    pip install --no-cache-dir horovod==0.19.4 &&\
    ldconfig